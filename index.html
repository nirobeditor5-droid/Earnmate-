<!DOCTYPE html>
<html>
<head>
  <title>EarnMate Mini App</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <style>
    body { font-family: Arial; margin: 20px; }
    #adminPanel { display:none; border:1px solid #ccc; padding:10px; margin-top:20px; }
    table { border-collapse: collapse; width:100%; margin-top:10px; }
    th, td { border:1px solid #ccc; padding:5px; text-align:center; }
    button { padding:5px 10px; margin:2px; cursor:pointer; }
  </style>
</head>
<body>

<h2>EarnMate Mini App</h2>

<div id="userSection">
  <p>Your Coins: <span id="coins">0</span></p>
  <button onclick="watchAd()">Watch Ad (+50 Coins)</button>
  <button onclick="sendReferral()">Referral (+200 Coins)</button>
  <h3>Withdraw</h3>
  <input type="number" id="withdrawAmount" placeholder="Coins to withdraw">
  <button onclick="requestWithdraw()">Request Withdraw</button>
</div>

<hr>

<h3>Admin Login</h3>
<input type="text" id="adminUser" placeholder="Admin ID">
<input type="password" id="adminPass" placeholder="Password">
<button onclick="adminLogin()">Login</button>

<div id="adminPanel">
  <h3>Admin Panel</h3>
  <p>Total Users: <span id="totalUsers">0</span></p>

  <h4>Monetag Zone ID</h4>
  <input type="text" id="zoneIdInput" placeholder="Enter Zone ID">
  <button onclick="updateZoneId()">Update Zone ID</button>
  <div id="monetagAd"></div>

  <h4>Users</h4>
  <table id="usersTable">
    <tr>
      <th>User ID</th>
      <th>Coins</th>
      <th>Adjust Coins</th>
      <th>Withdraw Requests</th>
    </tr>
  </table>
</div>

<script>
  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyAVjSwumtY6oqS7QFbcfTH4CY4UizaV2lk",
    authDomain: "earnmate-aadb9.firebaseapp.com",
    databaseURL: "https://earnmate-aadb9-default-rtdb.firebaseio.com",
    projectId: "earnmate-aadb9",
    storageBucket: "earnmate-aadb9.firebasestorage.app",
    messagingSenderId: "631886987492",
    appId: "1:631886987492:web:9ce92605037552dbb0ecf1"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Random user id
  let userId = localStorage.getItem("userId");
  if(!userId){ userId = "user_" + Date.now(); localStorage.setItem("userId", userId); }

  // Initialize user
  const userRef = db.ref("users/" + userId);
  userRef.once("value", snap=>{
    if(!snap.exists()){
      userRef.set({coins:0, referrals:0});
    }
  });

  function updateCoinsDisplay(){
    userRef.once("value", snap=>{
      document.getElementById("coins").innerText = snap.val().coins;
    });
  }
  updateCoinsDisplay();

  function watchAd(){
    userRef.once("value", snap=>{
      const newCoins = snap.val().coins + 50;
      userRef.update({coins: newCoins});
      updateCoinsDisplay();
      alert("You earned 50 coins!");
    });
  }

  function sendReferral(){
    userRef.once("value", snap=>{
      const newCoins = snap.val().coins + 200;
      userRef.update({coins: newCoins});
      updateCoinsDisplay();
      alert("You earned 200 coins for referral!");
    });
  }

  function requestWithdraw(){
    const amount = parseInt(document.getElementById("withdrawAmount").value);
    if(isNaN(amount) || amount <= 0){
      alert("Enter valid amount");
      return;
    }
    userRef.once("value", snap=>{
      const coins = snap.val().coins;
      if(amount > coins){
        alert("Not enough coins!");
        return;
      }
      db.ref("withdraw_requests/"+userId).set({coins:amount, status:"pending"});
      alert("Withdraw request sent!");
    });
  }

  // Admin Login
  const ADMIN_ID = "Nirob";
  const ADMIN_PASS = "Nirob123";

  function adminLogin(){
    const id = document.getElementById("adminUser").value;
    const pass = document.getElementById("adminPass").value;
    if(id === ADMIN_ID && pass === ADMIN_PASS){
      document.getElementById("adminPanel").style.display = "block";
      loadUsers();
      loadTotalUsers();
      loadMonetag();
      alert("Admin Logged In");
    } else alert("Invalid credentials");
  }

  function loadTotalUsers(){
    db.ref("users").once("value", snap=>{
      document.getElementById("totalUsers").innerText = snap.numChildren();
    });
  }

  function loadUsers(){
    db.ref("users").once("value", snap=>{
      const table = document.getElementById("usersTable");
      // clear except header
      table.innerHTML = `<tr>
        <th>User ID</th>
        <th>Coins</th>
        <th>Adjust Coins</th>
        <th>Withdraw Requests</th>
      </tr>`;
      snap.forEach(child=>{
        const uid = child.key;
        const coins = child.val().coins;
        const row = table.insertRow();
        row.insertCell(0).innerText = uid;
        row.insertCell(1).innerText = coins;

        // Adjust coins input
        const adjCell = row.insertCell(2);
        const input = document.createElement("input");
        input.type="number"; input.placeholder="Enter coins";
        const addBtn = document.createElement("button"); addBtn.innerText="+";
        const subBtn = document.createElement("button"); subBtn.innerText="-";
        addBtn.onclick = ()=>{ adjustCoins(uid, parseInt(input.value||0)); }
        subBtn.onclick = ()=>{ adjustCoins(uid, -parseInt(input.value||0)); }
        adjCell.appendChild(input); adjCell.appendChild(addBtn); adjCell.appendChild(subBtn);

        // Withdraw requests
        const wdCell = row.insertCell(3);
        db.ref("withdraw_requests/"+uid).once("value", wdSnap=>{
          if(wdSnap.exists()){
            const wdData = wdSnap.val();
            wdCell.innerHTML = `Coins: ${wdData.coins} Status: ${wdData.status} `;
            if(wdData.status==="pending"){
              const approveBtn = document.createElement("button"); approveBtn.innerText="Approve";
              const rejectBtn = document.createElement("button"); rejectBtn.innerText="Reject";
              approveBtn.onclick = ()=>{ approveWithdraw(uid, wdData.coins); }
              rejectBtn.onclick = ()=>{ rejectWithdraw(uid); }
              wdCell.appendChild(approveBtn); wdCell.appendChild(rejectBtn);
            }
          } else wdCell.innerText = "No request";
        });
      });
    });
  }

  function adjustCoins(uid, amount){
    const ref = db.ref("users/"+uid);
    ref.once("value", snap=>{
      const current = snap.val().coins;
      ref.update({coins: current + amount});
      loadUsers();
      loadTotalUsers();
    });
  }

  function approveWithdraw(uid, coins){
    const userRef = db.ref("users/"+uid);
    userRef.once("value", snap=>{
      const current = snap.val().coins;
      if(current >= coins){
        userRef.update({coins: current - coins});
        db.ref("withdraw_requests/"+uid).update({status:"approved"});
        loadUsers();
      } else alert("Not enough coins for user");
    });
  }

  function rejectWithdraw(uid){
    db.ref("withdraw_requests/"+uid).update({status:"rejected"});
    loadUsers();
  }

  // Monetag
  let currentZoneId = "";
  function updateZoneId(){
    currentZoneId = document.getElementById("zoneIdInput").value;
    loadMonetag();
  }

  function loadMonetag(){
    const div = document.getElementById("monetagAd");
    div.innerHTML = "";
    if(currentZoneId){
      const script = document.createElement("script");
      script.src="https://libtl.com/sdk.js";
      script.setAttribute("data-zone", currentZoneId);
      script.setAttribute("data-sdk","show_"+currentZoneId);
      div.appendChild(script);
    }
  }

  // Auto-update user coins display
  setInterval(updateCoinsDisplay, 3000);

</script>

</body>
</html>
